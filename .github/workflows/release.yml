name: ðŸŽ Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      ship_run_id:
        description: ID of the GitHub workflow run to ship
        required: true

run-name: ${{ github.ref_name }}

jobs:
  release:
    runs-on: ubuntu-24.04
    permissions:
      actions: read # Required to download artifacts
      contents: write # Upload artifacts to Release
      id-token: write # Required for NuGet CLI Login
    steps:
    - name: ðŸ”Ž Search for build of ${{ github.ref }}
      shell: pwsh
      id: findrunid
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        if ('${{ inputs.ship_run_id }}') {
          $runid = '${{ inputs.ship_run_id }}'
        } else {
          $restApiRoot = '/repos/${{ github.repository }}'

          # Resolve the tag reference to a commit sha
          $resolvedRef = gh api `
            -H "Accept: application/vnd.github+json" `
            -H "X-GitHub-Api-Version: 2022-11-28" `
            $restApiRoot/git/ref/tags/${{ github.ref_name }} `
            | ConvertFrom-Json
          $commitSha = $resolvedRef.object.sha

          Write-Host "Resolved ${{ github.ref_name }} to $commitSha"

          $releases = gh run list -R ${{ github.repository }} -c $commitSha -w .github/workflows/build.yml -s success --json databaseId,startedAt `
            | ConvertFrom-Json | Sort-Object startedAt -Descending

          if ($releases.length -eq 0) {
            Write-Error "No successful builds found for ${{ github.ref }}."
          } elseif ($releases.length -gt 1) {
            Write-Warning "More than one successful run found for ${{ github.ref }}. Artifacts from the most recent successful run will ship."
          }

          $runid = $releases[0].databaseId
        }

        Write-Host "Using artifacts from run-id: $runid"

        Echo "runid=$runid" >> $env:GITHUB_OUTPUT

    - name: ðŸ”» Download deployables artifacts
      uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
      with:
        name: deployables-Linux
        path: ${{ runner.temp }}/deployables
        run-id: ${{ steps.findrunid.outputs.runid }}
        github-token: ${{ github.token }}

    - name: ðŸ’½ Upload artifacts to release
      shell: pwsh
      if: ${{ github.event_name == 'release' && github.event.release.assets_url != '' }}
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        Get-ChildItem '${{ runner.temp }}/deployables' -File -Recurse |% {
          Write-Host "Uploading $($_.Name) to release..."
          gh release -R ${{ github.repository }} upload "${{ github.ref_name }}" $_.FullName
        }

    - name: ðŸªª Authorize NuGet package push
      uses: NuGet/login@d22cc5f58ff5b88bf9bd452535b4335137e24544 # v1
      id: nuget-login
      with:
        user: ${{ secrets.NUGET_USER }}

    - name: ðŸš€ Push NuGet packages
      run: dotnet nuget push ${{ runner.temp }}/deployables/*.nupkg --source https://api.nuget.org/v3/index.json -k '${{ steps.nuget-login.outputs.NUGET_API_KEY }}'
